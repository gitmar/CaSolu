@page "/regfallback"
@using System.ComponentModel.DataAnnotations
@using System.Dynamic
@using System.Text
@using BlazorBootstrap
@using CxClie.Services
@using CxShared.Models
@using CxShared.Others
@using Microsoft.AspNetCore.WebUtilities
@using Newtonsoft.Json
@using SQLitePCL

@inject IHttpClientFactory _httpFactorer
@inject NavigationManager _navmanager
@inject IJSRuntime JS

<h3 class="mb-3 text-primary">Invite Link Generator</h3>

<EditForm Model="@_invModel">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="container">
        <div class="row mb-2">
            <div class="col-1">
                <label for="toweb">website:</label>
            </div>
            <div class="col-4 text-left">
                @if (_myCatal?.Regions?.Count > 0)
                {
                    <InputSelect id="ppays" @bind-Value="_invModel.Iwurl" class="form-select">
                        @foreach (var utp in _myCatal.Regions)
                        {
                            <option value="@utp.Elea">@utp.Abg @utp.Liba</option>
                        }
                    </InputSelect>
                }
                else if (_myCatal == null)
                {
                    <p>Loading...</p>
                }
                else
                {
                    <p>pas de website</p>
                }
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="todom">domaine:</label>
            </div>
            <div class="col-2 text-left">
                @if (_myCatal?.Domas?.Count > 0)
                {
                    <InputSelect id="ppays" @bind-Value="_invModel.Idoma" class="form-select">
                        @foreach (var utp in _myCatal.Domas)
                        {
                            <option value="@utp.Elea">@utp.Liba</option>
                        }
                    </InputSelect>
                }
                else if (_myCatal == null)
                {
                    <p>Loading...</p>
                }
                else
                {
                    <p>pas de domaine</p>
                }
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="raison">Qte:</label>
            </div>
            <div class="col-1">
                <InputNumber id="raison" required @bind-Value="_invModel.Iqmax" class="form-control" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="raison">Raison:</label>
            </div>
            <div class="col-5">
                <InputText id="raison" required @bind-Value="_invModel.Raison" class="form-control" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="sigle">Sigle:</label>
            </div>
            <div class="col-3">
                <InputText id="sigle" required @bind-Value="_invModel.Sigle" class="form-control" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="ouname">Pseudo :</label>
            </div>
            <div class="col-2">
                (6 to 15 characters)
                <InputText id="ouname" required @bind-Value="_invModel.UsernameOrEmail" class="form-control" />
                <ValidationMessage For="@(() => _invModel.UsernameOrEmail)" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="phone">No Phone:</label>
            </div>
            <div class="col-2">
                <InputText id="phone" required @bind-Value="_invModel.Phonenumber" placeholder="phonenumber" class="form-control" />
                <ValidationMessage For="@(() => _invModel.Phonenumber)" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="email">Email:</label>
            </div>
            <div class="col-3">
                <InputText id="omail" required @bind-Value="_invModel.Email" class="form-control" />
                <ValidationMessage For="@(() => _invModel.Email)" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="onom">Nom:</label>
            </div>
            <div class="col-2">
                <InputText id="onom" required @bind-Value="_invModel.Nom" class="form-control" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="opnoms">Prenom(s):</label>
            </div>
            <div class="col-2">
                <InputText id="opnoms" required @bind-Value="_invModel.Pnom" class="form-control" />
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="Srole">Role:</label>
            </div>
            <div class="col-2">
                <label class="bg-danger bg-opacity-10" id="Toqsrole">@_invModel.Srole</label>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="ppays">Pays:</label>
            </div>
            <div class="col-2">
                @if (_myCatal?.Countries?.Count > 0)
                {
                    <InputSelect id="ppays" @bind-Value="_invModel.Ipays" class="form-select">
                        @foreach (var utp in _myCatal.Countries)
                        {
                            <option value="@utp.Elea">@utp.Liba</option>
                        }
                    </InputSelect>
                }
                else if (_myCatal == null)
                {
                    <p>Loading...</p>
                }
                else
                {
                    <p>pas de pays</p>
                }
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-1">
                <label for="plang">Langue:</label>
            </div>
            <div class="col-2">
                @if (_myCatal?.Langues?.Count > 0)
                {
                    <InputSelect id="plang" @bind-Value="_invModel.Ilang" class="form-select">
                        @foreach (var utp in _myCatal.Langues)
                        {
                            <option value="@utp.Elea">@utp.Liba</option>
                        }
                    </InputSelect>
                }
                else if (_myCatal == null)
                {
                    <p>Loading...</p>
                }
                else
                {
                    <p>pas de langue</p>
                }
            </div>
        </div>
    </div>
    <div class="mt-3">
        <button class="btn btn-primary" @onclick="VaGenererLink">Generate Invite Link</button>
    </div>
    @if (isLinkGenerated)
    {
        <div class="mt-3">
            <button class="btn btn-outline-secondary ms-2" type="button" @onclick="CopyToClipboard" disabled="@string.IsNullOrWhiteSpace(generatedLink)">
                Copy
            </button>
            <button class="btn btn-success ms-2" type="button" @onclick="SendEmailAsync" disabled="@string.IsNullOrWhiteSpace(generatedLink)">
                Send Email
            </button>
        </div>
    }

</EditForm>

@if (isLinkGenerated)
{
    <div class="alert alert-success mt-3">
        <strong>Generated Link:</strong>
        <div class="text-break">@generatedLink</div>
    </div>
    <div class="text-center mt-4">
        <canvas id="qrCanvas" width="256" height="256"></canvas>
        <div class="mt-2">
            <button class="btn btn-outline-dark" @onclick="DownloadQrCode">Download QR Code</button>
        </div>
    </div>
}

@code {
    private bool isLoading = false, errors = false, success = false;
    private bool isLinkGenerated = false;
    private string successmsg = "";
    private List<string> errorList = new List<string>();

    private string _password = "", _confirmPassword = "";
    private string UserLogged = "";
    private bool PeutEnvoyerMail = false;

    private HttpClient _apiClient;
    private TableSet _myCatal = new();
    private UsrOgSetModel _invModel = new();

    private Customer _curCustomer = new();
    private Order _curOrder = new();

    private string? generatedLink;

    protected override async Task OnInitializedAsync()
    {
        //Batteries.Init();
        _apiClient = _httpFactorer.CreateClient("wApiClient");
        _myCatal = await _apiClient.GetFromJsonAsync<TableSet>("collects/tables");
        _invModel.Irole = 3;
        _invModel.Srole = "Admin"; //queryParams["tqsrole"];
        _invModel.Password = "Jesuis@99";
        _invModel.ConfirmPassword = "Jesuis@99";
    }
    //GENERATING
    // private void VaGenererLink()
    // {
    //     isLinkGenerated = false;
    //     Console.WriteLine($" Sites : {_myCatal.Regions.Count()}");
    //     var usite = _myCatal.Regions.Where(wi => wi.Elea == _invModel.Isite).FirstOrDefault();
    //     if (usite == null)
    //     {
    //         return;
    //     }
    //     //var baseUrl = usite.Liba; //https://mysite.com;
    //     var baseUrl = _apiClient.BaseAddress.AbsoluteUri.ToString();
    //     var _linkGenerator = new LinkGenerator(JS);
    //     Console.WriteLine($"entree du lien : {baseUrl} et {_invModel.Raison}");
    //     generatedLink = _linkGenerator.GenerateLink(_invModel, baseUrl);
    //     isLinkGenerated = true;
    // }
    private void VaGenererLink()
    {
        isLinkGenerated = false;
        //var usite = _myCatal.Regions.FirstOrDefault(wi => wi.Elea == _invModel.Isite);
        //if (usite == null)
        //    return;

        // Use HttpClient's BaseAddress
        var baseUrl = _navmanager.BaseUri;
        //var baseUrl = _apiClient.BaseAddress?.AbsoluteUri ?? "https://fallback-url.com/";
        var _linkGenerator = new LinkSerialiser(JS);
        generatedLink = _linkGenerator.GenerateLink(_invModel, baseUrl, "custregister");
        isLinkGenerated = true;
    }
    private async Task CopyToClipboard() =>
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", generatedLink);

    private async Task DownloadQrCode() =>
        await JS.InvokeVoidAsync("downloadQrCanvas");

    private async Task SaveToDatabase()
    {
        //generate str keys
        PeutEnvoyerMail = false;
        isLoading = true;
        try
        {
            //customer
            _curCustomer.Email = _invModel.Email;
            _curCustomer.Nom = _invModel.Nom;
            _curCustomer.Pnom = _invModel.Pnom;
            _curCustomer.Role = _invModel.Srole;
            _curCustomer.Phonenumber = _invModel.Phonenumber;
            _curCustomer.Phon2 = _invModel.Phon2;
            _curCustomer.Ipays = _invModel.Ipays;
            _curCustomer.Ilang = _invModel.Ilang;
            //order
            var myregion = _myCatal.Regions.Where(uc => uc.Elea == _invModel.Iwurl).FirstOrDefault();
            if (myregion == null) return;
            _curCustomer.Weburl = myregion.Liba;
            //_curOrder.Doma = _invModel.Idoma;
            //_curOrder.Raison = _invModel.Raison;
            //_curOrder.Sigle = _invModel.Sigle;
            _curOrder.Olang = _invModel.Olang;
            _curOrder.Step = 1;
            // Await the async call to get the Order (or Customer depending on your endpoint)
            var respcust = await _apiClient.PostAsJsonAsync<Customer>("customers/creacustomer", _curCustomer);
            //recup _curCustomer.Idstr
            var respordo = await _apiClient.PostAsJsonAsync<Order>("orders/creaorder", _curOrder);
            //recup _curOrder.OIdstr;
            PeutEnvoyerMail = true;
        }
        catch (Exception ex)
        {
            // Handle or log error
            PeutEnvoyerMail = false;
        }
    }
    private async Task SendEmailAsync()
    {
        //var qrBase64 = await JS.InvokeAsync<string>("getQrBase64");
        var emailReq = new InviteEmailRequest
        {
            To = _invModel.Email,
            Subject = "Enregistrement sur le siteWeb",
            //Message = $"Hello, vyou’ve been invited. Click below to register:\n\n{generatedLink}",
            Message = $"Hello, cliquez sur le lien ci-dessous pour le faire:\n\n{generatedLink}",
            InviteLink = generatedLink!,
            //QrBase64 = qrBase64
        };
        var response = await _apiClient.PostAsJsonAsync("invite/sendemail", emailReq);
        if (response.IsSuccessStatusCode)
            await JS.InvokeVoidAsync("alert", "✅ Email sent successfully!");
        else
            await JS.InvokeVoidAsync("alert", "❌ Failed to send email!");
    }

    private async Task<string> GenerateCustomerStrNumber()
    {
        //a fabriquer//????yyyyMMddHH
        string wchai = _curCustomer.Pnom.Substring(0, 4);
        var curData = DateTime.Now;
        string dpas = curData.Year.ToString();
        dpas = "2900".Substring(0, 4 - dpas.Length) + dpas;
        wchai = wchai + dpas;
        dpas = curData.Month.ToString();
        dpas = "00".Substring(0, 2 - dpas.Length) + dpas;
        wchai = wchai + dpas;
        dpas = curData.Day.ToString();
        dpas = "00".Substring(0, 2 - dpas.Length) + dpas;
        wchai = wchai + dpas;
        dpas = curData.Hour.ToString();
        dpas = "00".Substring(0, 2 - dpas.Length) + dpas;
        wchai = wchai + dpas;
        return wchai;
    }
}


